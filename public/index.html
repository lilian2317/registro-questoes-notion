<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro rápido — % de acertos</title>
  <style>
    :root { --bg:#0b0b0b; --card:#141414; --muted:#b7b7b7; --line:#2a2a2a; --radius:18px; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:#fff; }
    header{ padding:18px 16px; text-align:center; font-size:22px; font-weight:900; letter-spacing:.2px; }
    .wrap{ max-width:820px; margin:0 auto; padding:14px; display:grid; gap:12px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    select,input,button{ font-size:18px; padding:14px 14px; border-radius:14px; border:1px solid var(--line); background:#0f0f0f; color:#fff; }
    input{ flex:1; min-width:220px; }
    button{ font-weight:800; cursor:pointer; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .muted{ color:var(--muted); font-size:14px; }
    .results{ display:grid; gap:8px; margin-top:10px; }
    .item{ padding:12px; border:1px solid var(--line); border-radius:14px; background:#0f0f0f; cursor:pointer; }
    .item:hover{ outline:2px solid #2f2f2f; }
    .title{ font-weight:800; }
    .chips{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{ padding:12px 14px; border-radius:999px; border:1px solid var(--line); background:#101010; font-weight:900; }
    .chip:hover{ outline:2px solid #2f2f2f; }
    .ok{ padding:10px 12px; border-radius:14px; border:1px solid var(--line); background:#0f0f0f; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .grid2{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>Registro rápido — % de acertos</header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <select id="base">
          <option value="TRT">TRT</option>
          <option value="TRE">TRE</option>
          <option value="PGE">Revisão PGE</option>
        </select>
        <input id="q" placeholder="Buscar assunto (ex.: Supremacia, Constituição...)" />
        <button id="btnBuscar">Buscar</button>
      </div>
      <div class="muted" style="margin-top:8px">
        Dica: digite só uma palavra do assunto e clique no resultado certo.
      </div>
      <div id="results" class="results"></div>
    </div>

    <div class="card" id="cardSel" style="display:none">
      <div class="title" id="selTitle">—</div>
      <div class="muted" id="selMeta">—</div>

      <div style="height:10px"></div>

      <div class="grid2">
        <input id="total" type="number" value="5" min="1" />
        <input id="hits" type="number" value="0" min="0" />
      </div>

      <div style="height:10px"></div>

      <div class="chips" id="chips"></div>

      <div style="height:10px"></div>

      <div class="row">
        <button id="btnSalvar">Salvar no Notion</button>
        <label class="muted" style="display:flex; gap:10px; align-items:center">
          <input id="setDate" type="checkbox" checked style="width:20px; height:20px; padding:0" />
          atualizar data de revisão (hoje)
        </label>
      </div>

      <div style="height:10px"></div>
      <div id="msg" class="ok" style="display:none"></div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let selected = null;

  function showMsg(text){
    const el = $("msg");
    el.style.display = "block";
    el.textContent = text;
  }

  function clearMsg(){
    $("msg").style.display = "none";
    $("msg").textContent = "";
  }

  function renderChips(total){
    const wrap = $("chips");
    wrap.innerHTML = "";
    for (let h=0; h<=total; h++){
      const b = document.createElement("button");
      b.className = "chip";
      b.textContent = `${h}/${total}`;
      b.onclick = () => { $("hits").value = h; };
      wrap.appendChild(b);
    }
  }

  $("total").addEventListener("input", () => {
    const t = Math.max(1, Number($("total").value || 5));
    renderChips(t);
    if (Number($("hits").value) > t) $("hits").value = t;
  });

  renderChips(5);

  async function buscar(){
    clearMsg();
    const base = $("base").value;
    const q = $("q").value.trim();
    if (!q) return;

    $("btnBuscar").disabled = true;
    $("results").innerHTML = `<div class="muted">Buscando...</div>`;

    try{
      const r = await fetch(`/api/query?base=${encodeURIComponent(base)}&q=${encodeURIComponent(q)}`);
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || "Erro na busca");

      const res = data.results || [];
      if (!res.length){
        $("results").innerHTML = `<div class="muted">Nada encontrado.</div>`;
        return;
      }

      $("results").innerHTML = "";
      res.forEach(item => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<div class="title">${item.title || "(sem título)"}</div><div class="muted">Clique para registrar</div>`;
        div.onclick = () => selectItem(item);
        $("results").appendChild(div);
      });

    }catch(e){
      $("results").innerHTML = `<div class="muted">Erro: ${e.message}</div>`;
    }finally{
      $("btnBuscar").disabled = false;
    }
  }

  function selectItem(item){
    selected = item;
    $("cardSel").style.display = "block";
    $("selTitle").textContent = item.title || "(sem título)";
    $("selMeta").textContent = `Página Notion: ${item.id}`;
    clearMsg();
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  async function salvar(){
    if (!selected) return;
    clearMsg();
    const base = $("base").value;
    const total = Number($("total").value || 5);
    const hits  = Number($("hits").value || 0);

    $("btnSalvar").disabled = true;
    showMsg("Salvando...");

    try{
      const r = await fetch("/api/update", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          base,
          pageId: selected.id,
          hits,
          total,
          setDate: $("setDate").checked
        })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.error || "Erro ao salvar");

      showMsg(`Salvo! (${hits}/${total})`);
    }catch(e){
      showMsg(`Erro: ${e.message}`);
    }finally{
      $("btnSalvar").disabled = false;
    }
  }

  $("btnBuscar").onclick = buscar;
  $("q").addEventListener("keydown", (e) => { if (e.key === "Enter") buscar(); });
  $("btnSalvar").onclick = salvar;
</script>
</body>
</html>
